# üê≥ Docker Migration Guide\n\n## Overview\n\nThis guide explains how to migrate NailIt's staging and production environments from source code deployment to Docker-based deployment on AWS App Runner.\n\n## Current Status\n\n‚úÖ **Development**: Already using Docker deployment  \n‚ùå **Staging**: Using source code deployment (needs migration)  \n‚ùå **Production**: Using source code deployment (needs migration)\n\n## Why Migrate to Docker?\n\n### Benefits of Docker Deployment:\n- **Consistent builds**: Same container across all environments\n- **Faster deployments**: Pre-built images vs building from source\n- **Better caching**: Docker layer caching improves build times\n- **Enhanced security**: Controlled base images and dependencies\n- **CI/CD integration**: GitHub Actions builds and pushes images\n- **Environment parity**: Development, staging, and production use identical containers\n\n### Current Issues with Source Code Deployment:\n- **Slower builds**: App Runner builds from source on every deployment\n- **Inconsistent environments**: Different build environments can cause issues\n- **Limited control**: Less control over build process and dependencies\n- **GitHub Actions mismatch**: CI/CD pipeline builds Docker images but staging/production use source\n\n## Migration Process\n\n### Prerequisites\n\n1. **Ensure .env.secrets is configured**:\n   ```bash\n   cd infrastructure\n   ls -la .env.secrets  # Should exist with all environment variables\n   ```\n\n2. **Verify GitHub Actions are working**:\n   - Development Docker deployment should be successful\n   - ECR repositories should exist for staging and production\n\n3. **Check AWS CLI access**:\n   ```bash\n   aws apprunner list-services  # Should show current services\n   ```\n\n### Migration Steps\n\n#### 1. Migrate Staging Environment\n\n```bash\ncd infrastructure\n./scripts/migrate-to-docker.sh staging\n```\n\nThis will:\n- Deploy ECR repository for staging (if not exists)\n- Update secrets in AWS Secrets Manager\n- Redeploy App Runner service in Docker mode\n- Configure service to use ECR images instead of source code\n\n#### 2. Test Staging Environment\n\n```bash\n# Check deployment status\naws apprunner describe-service --service-arn $(aws apprunner list-services --query 'ServiceSummaryList[?ServiceName==`nailit-staging`].ServiceArn' --output text)\n\n# Get new staging URL (may have changed)\naws apprunner list-services --query 'ServiceSummaryList[?ServiceName==`nailit-staging`].ServiceUrl' --output text\n```\n\n#### 3. Trigger GitHub Actions for Staging\n\n```bash\n# Switch to staging branch and push to trigger deployment\ngit checkout staging\ngit merge develop  # Merge latest changes\ngit push origin staging  # Triggers GitHub Actions Docker build\n```\n\n#### 4. Migrate Production Environment\n\n**Only after staging is verified working:**\n\n```bash\ncd infrastructure\n./scripts/migrate-to-docker.sh production\n```\n\n#### 5. Test Production Environment\n\n```bash\n# Check deployment status\naws apprunner describe-service --service-arn $(aws apprunner list-services --query 'ServiceSummaryList[?ServiceName==`nailit-prod`].ServiceArn' --output text)\n\n# Get new production URL (may have changed)\naws apprunner list-services --query 'ServiceSummaryList[?ServiceName==`nailit-prod`].ServiceUrl' --output text\n```\n\n#### 6. Trigger GitHub Actions for Production\n\n```bash\n# Switch to main branch and push to trigger deployment\ngit checkout main\ngit merge staging  # Merge tested changes\ngit push origin main  # Triggers GitHub Actions Docker build\n```\n\n### Post-Migration Updates\n\n#### Update URLs in Documentation\n\nAfter migration, App Runner may assign new URLs. Update these files:\n\n1. **Update .env.secrets**:\n   ```bash\n   # Get new URLs\n   STAGING_URL=$(aws apprunner list-services --query 'ServiceSummaryList[?ServiceName==`nailit-staging`].ServiceUrl' --output text)\n   PROD_URL=$(aws apprunner list-services --query 'ServiceSummaryList[?ServiceName==`nailit-prod`].ServiceUrl' --output text)\n   \n   # Update .env.secrets with new URLs\n   ```\n\n2. **Update documentation files**:\n   - `docs/deployment/ENVIRONMENT_URLS.md`\n   - `docs/deployment/CICD_IMPLEMENTATION_SUMMARY.md`\n   - `README.md`\n   - `tests/integration/email-test-setup.ts`\n\n#### Redeploy Secrets with New URLs\n\n```bash\n# After updating .env.secrets with new URLs\ncd infrastructure\n./scripts/deploy-with-secrets.sh staging\n./scripts/deploy-with-secrets.sh production\n```\n\n## Verification Checklist\n\n### ‚úÖ Migration Success Indicators\n\n- [ ] App Runner service shows `ImageRepository` configuration (not `CodeRepository`)\n- [ ] GitHub Actions successfully builds and pushes Docker images\n- [ ] Application loads correctly on new URLs\n- [ ] Environment variables and secrets are properly configured\n- [ ] Database connections work correctly\n- [ ] OAuth authentication works with new URLs\n\n### üîç Troubleshooting\n\n#### Service Won't Start\n```bash\n# Check App Runner logs\naws logs describe-log-groups --log-group-name-prefix \"/aws/apprunner\"\naws logs get-log-events --log-group-name \"/aws/apprunner/nailit-staging/application\"\n```\n\n#### Docker Image Issues\n```bash\n# Check ECR repository\naws ecr describe-repositories --repository-names nailit-staging\naws ecr list-images --repository-name nailit-staging\n```\n\n#### GitHub Actions Failures\n```bash\n# Check workflow status\ngh run list --workflow=\"Docker Build and Deploy\"\ngh run view <run-id>\n```\n\n## Rollback Plan\n\nIf migration fails, you can rollback by redeploying in source mode:\n\n```bash\ncd infrastructure\ncdk deploy AppRunner-staging --context environment=staging --context deploymentMode=source\n```\n\n**Note**: This will revert to the previous source code deployment configuration.\n\n## Benefits After Migration\n\n### üöÄ Improved CI/CD Pipeline\n- **Consistent deployment**: All environments use Docker\n- **Faster builds**: Cached Docker layers\n- **Better testing**: Same container across dev/staging/prod\n\n### üîí Enhanced Security\n- **Controlled dependencies**: Locked Docker base images\n- **Minimal attack surface**: Only necessary packages in container\n- **Consistent security**: Same security scanning across environments\n\n### üìà Better Performance\n- **Faster cold starts**: Pre-built images vs compiling from source\n- **Predictable resource usage**: Consistent container configuration\n- **Improved caching**: Docker layer and ECR caching" 